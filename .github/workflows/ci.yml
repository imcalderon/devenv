name: DevEnv CI/CD

on:
  push:
    branches: [ main, crossplatform ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: find . -type f -name "*.sh" -not -path "./.git/*" -exec shellcheck {} +

  json-validation:
    name: JSON Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON Files
        run: |
          find . -type f -name "*.json" -not -path "./.git/*" -not -path "*/node_modules/*" \
            -exec sh -c '
              for file do
                if ! jq . "$file" >/dev/null 2>&1; then
                  echo "Invalid JSON: $file"
                  exit 1
                fi
              done
            ' sh {} +

  unit-tests:
    name: Unit Tests (Linux)
    runs-on: ubuntu-latest
    needs: [shellcheck, json-validation]
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update && sudo apt-get install -y bats

      - name: Run bats tests
        run: bats tests/

  unit-tests-macos:
    name: Unit Tests (macOS)
    runs-on: macos-latest
    needs: [shellcheck, json-validation]
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: brew install bats-core

      - name: Run bats tests
        run: bats tests/

  psscriptanalyzer:
    name: PSScriptAnalyzer (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Get-ChildItem -Recurse -Filter '*.ps1' |
            ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning }
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Host "PSScriptAnalyzer found $($results.Count) issue(s)" -ForegroundColor Yellow
          } else {
            Write-Host "PSScriptAnalyzer: All clear" -ForegroundColor Green
          }

  installation-test:
    name: Installation Test (Linux)
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Test Git Module Installation
        run: sudo ./devenv.sh install git

      - name: Verify Git Installation
        run: ./devenv.sh verify git

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Module Documentation
        run: |
          missing=0
          for module in modules/*/; do
            if [ ! -f "${module}/README.md" ]; then
              echo "Warning: Missing README.md in ${module}"
              missing=$((missing + 1))
            fi
          done
          echo "$missing module(s) missing README.md"
