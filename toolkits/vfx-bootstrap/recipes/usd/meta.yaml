{% set name = "usd" %}
{% set version = "24.11" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://github.com/PixarAnimationStudios/OpenUSD/archive/v{{ version }}.tar.gz
  sha256: 1ab3dc387c8ce8c650d66143c86fb44ed6fe5c9638522bcb3226e85a401c4f69
  patches:                              # [win]
    - fix-pch-ninja-msvc.patch          # [win]

build:
  number: 0
  run_exports:
    - {{ pin_subpackage(name, max_pin='x.x') }}
  missing_dso_whitelist:            # [win]
    - "*/boost_*.dll"               # [win]
    - "*/Ptex.dll"                  # [win]
    - "*/Alembic.dll"               # [win]
    - "*/openvdb.dll"               # [win]
    - "*/osd_*.dll"                 # [win]
    - "*/MaterialX*.dll"            # [win]
    - "*/OpenImageIO*.dll"          # [win]
    - "*/OpenColorIO*.dll"          # [win]
    - "*/tbb*.dll"                  # [win]
    - "*/usd_*.dll"                 # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
    - ninja
  host:
    - python
    - boost
    - tbb
    - openexr
    - imath
    - opensubdiv
    - alembic
    - materialx
    - openvdb
    - openimageio
    - opencolorio
    - ptex
    - jinja2
    - pyopengl
  run:
    - python
    - {{ pin_compatible('boost', max_pin='x.x') }}
    - {{ pin_compatible('tbb', max_pin='x.x') }}
    - {{ pin_compatible('openexr', max_pin='x.x') }}
    - {{ pin_compatible('imath', max_pin='x.x') }}
    - opensubdiv
    - alembic
    - materialx
    - openvdb
    - openimageio
    - opencolorio
    - ptex
    - pyside6                        # [not win]
    - jinja2
    - pyopengl

test:
  imports:                                # [unix]
    - pxr.Usd                            # [unix]
    - pxr.UsdGeom                        # [unix]
    - pxr.UsdShade                       # [unix]
  commands:
    - usdcat --help
    - usdview --help  # [linux and x11]
    - test -f $PREFIX/lib/libusd_usd${SHLIB_EXT}  # [unix]
    - if not exist %LIBRARY_PREFIX%\lib\usd_usd.lib exit 1  # [win]
    - set "PATH=%LIBRARY_PREFIX%\lib;%PATH%" && python -c "from pxr import Usd; print('USD', Usd.GetVersion())"  # [win]

about:
  home: https://openusd.org/
  license: Apache-2.0
  license_file: LICENSE.txt
  summary: Universal Scene Description (USD)
  description: |
    Universal Scene Description (USD) is an efficient, scalable system
    for authoring, reading, and streaming time-sampled scene description
    for interchange between graphics applications.
  doc_url: https://openusd.org/docs/
  dev_url: https://github.com/PixarAnimationStudios/OpenUSD

extra:
  recipe-maintainers:
    - vfx-bootstrap
