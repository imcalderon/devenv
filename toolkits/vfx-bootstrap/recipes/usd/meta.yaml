{% set name = "usd" %}
{% set version = "24.11" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://github.com/PixarAnimationStudios/OpenUSD/archive/v{{ version }}.tar.gz
  sha256: 1ab3dc387c8ce8c650d66143c86fb44ed6fe5c9638522bcb3226e85a401c4f69
  patches:                                # [win]
    - fix-pch-ninja-msvc.patch            # [win]

build:
  number: 0
  run_exports:
    - {{ pin_subpackage(name, max_pin='x.x') }}
  missing_dso_whitelist:            # [win]
    - "*/boost_*.dll"               # [win]
    - "*/Ptex.dll"                  # [win]
    - "*/Alembic.dll"               # [win]
    - "*/openvdb.dll"               # [win]
    - "*/osd_*.dll"                 # [win]
    - "*/MaterialX*.dll"            # [win]
    - "*/OpenImageIO*.dll"          # [win]
    - "*/OpenColorIO*.dll"          # [win]
    - "*/tbb*.dll"                  # [win]
    - "*/usd_*.dll"                 # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
    - ninja
  host:
    - python
    - boost
    - tbb
    - openexr
    - imath
    - opensubdiv
    - alembic
    - materialx
    - openvdb
    - openimageio
    - opencolorio
    - ptex
    - jinja2
    - pyopengl
    - pyside6
  run:
    - python
    - {{ pin_compatible('boost', max_pin='x.x') }}
    - {{ pin_compatible('tbb', max_pin='x.x') }}
    - {{ pin_compatible('openexr', max_pin='x.x') }}
    - {{ pin_compatible('imath', max_pin='x.x') }}
    - opensubdiv
    - alembic
    - materialx
    - openvdb
    - openimageio
    - opencolorio
    - ptex
    - jinja2
    - pyopengl
    - pyside6

test:
  imports:
    - pxr.Usd
    - pxr.UsdGeom
    - pxr.UsdShade
  commands:
    - usdcat --help
    - usdview --help
    - test -f $PREFIX/lib/libusd_usd${SHLIB_EXT}  # [unix]
    - if not exist %LIBRARY_PREFIX%\lib\usd_usd.lib exit 1  # [win]
    # Ensure DLLs are in PATH so Python can load the C++ extensions
    - set "PATH=%LIBRARY_BIN%;%PATH%" && python -c "from pxr import Usd; print('USD Version:', Usd.GetVersion())"  # [win]

about:
  home: https://openusd.org/
  license: Apache-2.0
  license_file: LICENSE.txt
  summary: Universal Scene Description (USD)
  doc_url: https://openusd.org/docs/